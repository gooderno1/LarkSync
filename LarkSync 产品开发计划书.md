# **LarkSync 产品开发计划书**

**版本号**：V1.0

**日期**：2026-01-26

**基于文档**：《飞书云文档本地同步方案》、《LarkSync 产品需求文档》

## **1\. 项目概览 (Project Overview)**

### **1.1 项目背景**

针对开发者、技术写作者及重度文档用户，当前飞书云端文档（Docx）与本地文件系统（Markdown/Local Files）存在数据孤岛。LarkSync 旨在构建一套稳健的双向同步系统，实现“云端即时协作”与“本地离线编辑/归档”的无缝融合。

### **1.2 核心目标**

1. **双向互通**：支持云端与本地文件的双向实时/定时同步。  
2. **格式桥接**：实现 Docx 与 Markdown 的智能转码，支持图片资源本地化。  
3. **多端一致**：支持多设备环境下的状态同步与冲突处理。  
4. **体验无感**：低资源占用，后台静默运行，精准还原文件修改时间。

## **2\. 阶段里程碑规划 (Roadmap)**

为了降低技术风险，项目将分为三个阶段推进，采用迭代开发模式。

### **阶段一：MVP（最小可行性产品）- 单向备份与转码**

**目标**：跑通“云端 \-\> 本地”链路，确保核心的 Auth、Drive API 遍历和 Docx 转码功能可用。

**预计周期**：3 周

* **核心功能**：  
  * OAuth2.0 授权与 Token 管理。  
  * 全量/增量遍历云端目录树。  
  * Docx 下载并转码为 Markdown（含图片下载）。  
  * 本地 SQLite 状态库的建立。  
  * “仅下载”模式的实现。

### **阶段二：V1.0（正式版）- 双向同步与上传**

**目标**：跑通“本地 \-\> 云端”链路，实现完整的双向同步和冲突处理机制。

**预计周期**：4 周

* **核心功能**：  
  * 本地文件系统监听 (Watcher)。  
  * Markdown 解析并上传为 Docx (Block 组装)。  
  * 非 MD 文件 (Excel/Word) 的导入转换逻辑。  
  * **核心难点攻关**：时间戳同步逻辑（基于中间状态库）、冲突检测与解决策略。  
  * 双向同步模式上线。

### **阶段三：V1.1（增强版）- 性能优化与多端适配**

**目标**：解决 API 限流问题，优化大文件传输体验，提升 UI 易用性。

**预计周期**：2 周

* **核心功能**：  
  * 速率限制器 (Rate Limiter) 与指数退避重试。  
  * UI 交互界面优化（配置向导、日志面板）。  
  * 多设备 ID 隔离支持。  
  * 性能优化（内存目录树、差异比对算法）。

## **3\. 详细任务分解 (WBS)**

### **3.1 基础设施层 (Infrastructure)**

*此模块贯穿整个开发周期*

| 任务 ID | 任务名称 | 详细描述 | 优先级 |
| :---- | :---- | :---- | :---- |
| INF-01 | **项目脚手架搭建** | 确定技术栈 (如 Python/Go/Electron)，配置 CI/CD，日志系统 (Logging)。 | P0 |
| INF-02 | **SQLite 数据库设计** | 实现 sync\_mapping 表结构，封装 CRUD 接口，确保并发读写安全。 | P0 |
| INF-03 | **飞书 API Client 封装** | 封装 HTTP 请求，统一处理鉴权 (Auth)、刷新 Token、错误处理。 | P0 |
| INF-04 | **速率限制器 (Rate Limiter)** | 实现令牌桶算法，全局管控 API QPS (Drive 读写分离)，处理 429 错误。 | P1 |

### **3.2 核心同步引擎 (Core Sync Engine)**

#### **3.2.1 阶段一：下载链路 (Downstream)**

| 任务 ID | 任务名称 | 详细描述 | 优先级 |
| :---- | :---- | :---- | :---- |
| ENG-01 | **云端爬虫 (Crawler)** | 实现递归获取 folder\_token，构建云端目录树内存快照。 | P0 |
| ENG-02 | **状态比对逻辑 (Diff)** | 对比云端快照与 DB 状态，识别 Added, Modified, Deleted 文件。 | P0 |
| ENG-03 | **元数据同步** | 下载完成后，调用 OS API 修改本地文件的 mtime 以匹配云端。 | P0 |
| ENG-04 | **Docx 转码器 (To MD)** | 核心算法：解析 Block JSON AST \-\> 生成 Markdown 文本。处理 H1-H9, List, Bold, Code。 | P0 |
| ENG-05 | **媒体资源处理器** | 提取 Docx 中的 Image Token，下载图片至 assets/，替换 MD 引用链接。 | P1 |

#### **3.2.2 阶段二：上传链路 (Upstream)**

| 任务 ID | 任务名称 | 详细描述 | 优先级 |
| :---- | :---- | :---- | :---- |
| ENG-06 | **本地监听器 (Watcher)** | 监听文件系统事件 (Create, Modify, Move, Delete)，建立防抖机制 (Debounce)。 | P0 |
| ENG-07 | **Markdown 解析器 (To Docx)** | 核心算法：Markdown AST \-\> Feishu Block Spec。 | P0 |
| ENG-08 | **Office 导入适配** | 识别 xlsx/docx 文件，调用 import\_tasks API 进行转换上传。 | P1 |
| ENG-09 | **循环同步熔断** | 实现“上传静默期”逻辑，防止本地上传触发 Watcher 导致的死循环。 | P0 |
| ENG-10 | **冲突管理器** | 实现 Hash \+ Version 校验逻辑，生成冲突副本 (Conflicted Copy)。 | P1 |

### **3.3 用户交互层 (UI/UX)**

| 任务 ID | 任务名称 | 详细描述 | 优先级 |
| :---- | :---- | :---- | :---- |
| UI-01 | **授权登录流程** | 实现 OAuth2 浏览器跳转与回调监听，安全存储 Token。 | P0 |
| UI-02 | **同步任务配置向导** | 选择本地目录、选择云端目录、选择同步模式 (单向/双向)。 | P0 |
| UI-03 | **状态仪表盘** | 展示当前同步状态 (同步中/空闲/错误)、最近同步文件列表。 | P1 |
| UI-04 | **系统托盘集成** | 支持最小化到托盘，后台静默运行，气泡通知关键错误。 | P2 |

## **4\. 关键技术难点攻关方案**

根据技术调研，以下是本项目的三大核心风险点及应对策略：

### **4.1 难点：云端“最后修改时间”不可控**

* **问题**：本地旧文件上传后，云端时间戳会变为“当前时间”，导致其他设备误判为新文件。  
* **解决方案**：  
  * **依赖数据库而非时间戳**：同步判断逻辑强依赖本地 SQLite 中的 file\_hash 和 cloud\_version。  
  * **快照基准**：上传成功后，立即将“上传完成时的服务器时间”写入 DB 作为基准，后续对比时忽略该时间点之前的“伪更新”。

### **4.2 难点：Markdown 与 Docx 格式转换损耗**

* **问题**：飞书 Block 结构复杂（如复杂表格、iframe），标准 MD 无法完美承载。  
* **解决方案**：  
  * **降级策略**：对于无法转换的 Block（如复杂表格），在 MD 中渲染为 HTML 表格或插入 \[不支持的格式: Table\] 占位符。  
  * **原生透传**：对于完全无法解析的格式，转为作为 Docx 的附件处理（如有必要），或在日志中警告。

### **4.3 难点：API 速率限制 (Rate Limiting)**

* **问题**：全量遍历文件夹极易触发 5 QPS 限制。  
* **解决方案**：  
  * **本地缓存优先**：启动时信任本地 DB 结构，后台线程低频（如每5分钟）进行云端比对。  
  * **队列管理**：所有网络请求进入优先级队列，用户手动触发的操作优先级最高，后台轮询优先级最低。

## **5\. 质量保证与测试计划 (QA Plan)**

### **5.1 测试策略**

1. **单元测试**：重点覆盖 Transcoder (转码器)，准备大量 Markdown/Docx 样本文件进行互转测试，确保 AST 解析准确。  
2. **集成测试**：模拟网络波动、Token 过期、API 限流等场景，测试程序的鲁棒性。  
3. **场景测试**：  
   * **断网重连**：断网期间修改本地文件，联网后是否自动上传？  
   * **并发冲突**：两台设备同时修改同一文件，是否生成冲突副本？  
   * **大文件测试**：测试 100MB+ 文件和包含大量图片的文档同步稳定性。

### **5.2 验收标准 (Acceptance Criteria)**

1. **数据完整性**：文件内容 MD5 校验一致（排除转码导致的差异）。  
2. **时间准确性**：本地文件修改时间与云端误差不超过 2 秒。  
3. **稳定性**：连续运行 24 小时无崩溃，遇到 API 限流能自动恢复。

## **6\. 资源需求**

* **开发人员**：  
  * 后端/核心研发 (1人)：负责 API 对接、数据库、同步逻辑。  
  * 前端/客户端研发 (1人)：负责 UI、转码逻辑、打包发布。  
* **测试设备**：  
  * Windows 10/11 PC  
  * macOS (M1/M2) MacBook  
* **账号资源**：  
  * 飞书企业版测试租户 (用于申请 API 权限)。