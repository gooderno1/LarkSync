# LarkSync 代码审查报告（2026-02-16）

## 0.1 本轮用户反馈专项修复（2026-02-16）
- 已修复：同步任务页左侧菜单栏被压缩（`App.tsx` / `Sidebar.tsx` 布局约束补齐）。
- 已修复：托盘单实例锁失效导致的多实例抢占风险（`tray_app.py` 改为全局持有锁 socket，退出时释放）。
- 已修复：页面进入时“授权向导闪现”问题（`useAuth` / `useConfig` 去除 placeholder 误判，首屏先等真实状态）。
- 已修复：测试任务默认对业务视图的干扰（任务页默认隐藏“测试任务”，可手动切换显示）。
- 已增强：任务归属策略改为“设备 + 飞书账号(open_id)”双重绑定；历史无 open_id 任务会在首次访问时自动归属当前账号，避免同设备多账号串任务。
- 已增强：设备标识改为“机器指纹优先，文件随机值兜底”，降低跨设备测试时的任务串扰概率。

## 0.2 本轮补充修复（2026-02-16）
- 已修复：设置页“设备显示名称”入口迁移到“更多设置”分组（避免 OAuth 主流程噪音）。
- 已修复：飞书生产测试文件夹新增文档的 Markdown 缺失问题：
  - `equation` 公式元素渲染补齐；
  - `add_ons`（mermaid）块渲染补齐；
  - `sheet` 内嵌表格不再静默丢失，改为输出 `sheet_token` 占位信息。
- 已验证：清理目标 `sync_links` 后重跑任务 `fabae395-0534-45e6-a52d-93d39434c8b9`，4 个目标文档均重新下载，公式/流程图内容恢复。

## 0. 修复状态（2026-02-16）
- 本文“关键问题”已在当日完成修复并归档到：
  - `CHANGELOG.md`（v0.5.30）
  - `DEVELOPMENT_LOG.md`（v0.5.30）
- 其中“飞书文档同步脚本”因入口页当前未提供 zip 链接，改为“更新清单并提示 no_zip_found”，不再阻塞流程。
- 补充收敛：
  - `npm run dev` 在存在不兼容全局 `PYTHONPATH` 时也可启动（后端子进程自动过滤异常路径）。
  - `sync_runner` / `tray_status` / `logging` / `backend_manager` 回归用例已修复。
  - 后端全量测试已恢复通过（`cd apps/backend && python -m pytest tests -q`）。

## 1. 审查范围
- 文档基线：已按优先级阅读 `docs/local_specs`（SSOT/PRD/计划/调研/UX/参考）及 `README.md`、`docs/USAGE.md`、`docs/SYNC_LOGIC.md`、`docs/OAUTH_GUIDE.md`。
- 代码范围：`apps/backend`、`apps/frontend`、`apps/tray`、`scripts`。
- 验证动作：
  - `python scripts/sync_feishu_docs.py`（失败，详见问题 3）
  - `cd apps/frontend && npm run build`（通过）
  - `cd apps/backend && python -m pytest`（环境依赖冲突，详见“验证记录”）

## 2. 关键问题（按严重级别）

### [高] 版本读取正则写错，运行时版本恒为 `0.0.0`
- 位置：`apps/backend/src/core/version.py:9`
- 现象：
  - `_VERSION_PATTERN = re.compile(r'^version\\s*=\\s*"([^"]+)"', re.MULTILINE)` 使用了双反斜杠，正则会匹配字面量 `\s`，无法匹配实际的 TOML 行。
  - 实测命令：`cd apps/backend && python -c "from src.core.version import get_version; print(get_version())"` 输出 `0.0.0`。
- 影响：
  - 自动更新、版本展示、日志排障中的版本信息失真。
  - 任何依赖 `get_version()` 的逻辑都会基于错误版本工作。

### [高] 空 refresh_token 的 keyring 存储/读取不一致
- 位置：
  - 写入：`apps/backend/src/core/security.py:74`
  - 读取：`apps/backend/src/core/security.py:52`
- 现象：
  - 写入时空值被替换成 `"_empty_"`。
  - 读取时没有把 `"_empty_"` 还原为空字符串，最终把伪值当真实 refresh_token 使用。
- 影响：
  - 可能触发无效刷新请求，造成 OAuth 刷新失败与误导性错误。

### [高] 飞书文档同步脚本当前失效（规范中的前置步骤被阻塞）
- 位置：`scripts/sync_feishu_docs.py:21`, `scripts/sync_feishu_docs.py:50`, `scripts/sync_feishu_docs.py:94`
- 现象：
  - 当前运行 `python scripts/sync_feishu_docs.py` 返回：`未在页面中解析到 zip 文档，请检查页面结构是否变化。`
  - 当前实现依赖单一正则 `ZIP_ENTRY_PATTERN`，对页面结构变动非常敏感。
- 影响：
  - 按 AGENTS 规范，开发前同步飞书文档这一环节无法完成。
  - 文档来源易滞后，影响后续 API 对齐与开发准确性。

### [中] 版本源不一致，release 脚本存在误发布风险
- 位置：
  - 根版本：`package.json:4`（`v0.4.0-dev.4`）
  - 后端版本：`apps/backend/pyproject.toml:3`（`v0.5.27`）
  - 前端版本：`apps/frontend/package.json:4`（`0.5.27`）
  - release 逻辑：`scripts/release.py:11`, `scripts/release.py:74`, `scripts/release.py:95`
- 现象：
  - `release.py` 从根 `package.json` 读取当前版本并按 `vX.Y.Z-dev.N` 递增。
  - 但根版本明显落后于后端/前端与 CHANGELOG 最新版本（`v0.5.27`）。
- 影响：
  - 执行发布脚本可能从旧分支版本线继续 bump，导致版本回退或混乱。

### [中] 自动更新仅校验文件大小，不做完整性校验
- 位置：`apps/backend/src/services/update_service.py:213`, `apps/backend/src/services/update_service.py:222`, `apps/backend/src/services/update_service.py:228`
- 现象：
  - 下载逻辑仅在“已存在文件”场景比较 `size`，对新下载内容不做哈希校验。
  - 代码中不存在 `sha256` 校验逻辑。
- 影响：
  - 更新包被篡改或下载损坏时，缺少完整性保障。
  - 与升级计划中“校验 sha256”的安全目标不一致。

### [中] 全局异常直接回传详细错误到客户端
- 位置：`apps/backend/src/main.py:35`, `apps/backend/src/main.py:44`
- 现象：
  - 500 响应中直接返回 `"{type(exc).__name__}: {exc}"`。
- 影响：
  - 生产环境可能泄露内部异常细节（路径、第三方错误信息等）。
  - 建议区分开发/生产模式，生产仅返回通用错误码与请求 ID。

## 3. 验证记录
- 前端：
  - `cd apps/frontend && npm run build` 通过。
- 后端：
  - `cd apps/backend && python -m pytest` 未执行成功，报环境插件冲突：
  - `ImportError: cannot import name 'FixtureDef' from 'pytest'`（`pytest_asyncio` 与当前环境 pytest 不兼容）。
  - 该问题更偏向本机 Python 环境污染/依赖不一致，建议在隔离虚拟环境中按 `requirements-dev.txt` 重新安装。

## 4. 建议的处理顺序
1. 先修 `core/version.py` 的版本正则，并补 `get_version()` 单测。
2. 修复 `KeyringTokenStore` 空 refresh_token 读写一致性，并增加 keyring 分支测试。
3. 修复 `sync_feishu_docs.py` 解析策略（建议从页面 JSON 数据源提取，不依赖脆弱正则）。
4. 统一三处版本源（根/前端/后端）并校正 `release.py` 的版本策略。
5. 给更新下载加入 `sha256` 校验，失败时阻止安装并落日志。
6. 全局异常处理按环境分级输出，生产禁回显内部错误详情。
