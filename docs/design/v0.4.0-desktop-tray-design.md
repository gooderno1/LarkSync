# LarkSync v0.4.0 — 桌面托盘化设计文档

> 版本：v0.4.0 | 创建日期：2026-02-07 | 关联里程碑：v0.4.0 ~ v0.5.0

## 1. 背景与问题

LarkSync 是一个需要**持续在后台运行**的文件同步工具，但当前的使用方式存在根本缺陷：

| 环节 | 当前方式 | 问题 |
|------|---------|------|
| 启动 | 手动运行 `npm run dev` | 需要终端、终端不能关闭 |
| 管理 | 浏览器打开 `localhost:3666` | 依赖浏览器，关闭即失联 |
| 后台运行 | 终端进程挂起 | 关闭终端 = 同步停止 |
| 状态感知 | 必须主动打开网页查看 | 无通知、无快速入口 |
| 开机自启 | 不支持 | 每次开机需手动启动 |

产品需求文档已明确要求：**系统托盘集成（P2）** 和 **后台静默运行**。

## 2. 整体架构

```
┌─────────────────────────────────────────┐
│           系统托盘应用 (pystray)           │  ← 新增：桌面入口
│  [图标状态] [右键菜单] [气泡通知]          │
└────────────────┬────────────────────────┘
                 │ 管理后端生命周期
┌────────────────▼────────────────────────┐
│         FastAPI 单进程服务               │  ← 改造：前后端一体
│  API + 静态前端(dist/) + WebSocket       │
│  http://localhost:8000                   │
└────────────────┬────────────────────────┘
                 │ 需要时打开浏览器
┌────────────────▼────────────────────────┐
│         浏览器管理面板 (React UI)          │  ← 不变：详细管理
│  任务配置 / 日志查看 / 冲突处理            │
└─────────────────────────────────────────┘
```

**核心原则**：最小侵入——不改变现有 FastAPI + React 架构，只在外面套一个轻量级桌面管理层。

## 3. 模块设计

### 3.1 FastAPI 静态文件服务

**改造 `apps/backend/src/main.py`：**

- 检测 `apps/frontend/dist/` 目录是否存在
- 存在时：挂载 `/assets` 为静态资源目录，其余非 API 路径返回 `index.html`（SPA fallback）
- 不存在时：保持现有行为（开发模式，由 Vite 代理）

**效果**：一个 `uvicorn` 进程 = 完整应用（API + 前端 + WebSocket）。

### 3.2 系统托盘应用

**技术选型**：`pystray`（跨平台系统托盘）+ `Pillow`（图标）+ `plyer`（通知）

**文件结构**：
```
apps/tray/
├── __init__.py
├── tray_app.py          # 托盘主程序入口
├── backend_manager.py   # 后端进程管理（启动/停止/健康检查）
├── status_poller.py     # 状态轮询（定期查 /health + /sync/tasks/status）
├── notifier.py          # 系统通知管理
├── autostart.py         # 开机自启动配置（Windows/macOS）
├── config.py            # 托盘应用配置
└── icons/               # 托盘图标（4种状态，16x16/32x32 ICO/PNG）
    ├── icon_idle.png     # 绿色：空闲
    ├── icon_syncing.png  # 蓝色/黄色：同步中
    ├── icon_error.png    # 红色：有错误
    └── icon_paused.png   # 灰色：已暂停
```

**托盘右键菜单**：
```
┌──────────────────────────┐
│ LarkSync — 运行中         │  （状态文字，不可点击）
│──────────────────────────│
│ 📊 打开管理面板            │  → webbrowser.open(localhost:8000)
│ 🔄 立即同步              │  → POST /sync/tasks/{id}/run
│──────────────────────────│
│ ⏸ 暂停全部同步            │  （toggle）
│──────────────────────────│
│ ⚙ 设置                   │  → 打开设置页
│ 📋 查看日志               │  → 打开日志页
│──────────────────────────│
│ 🚀 开机自启动  ✓          │  → 切换自启动
│ ❌ 退出 LarkSync          │  → 优雅关闭后端 + 退出
└──────────────────────────┘
```

### 3.3 后端进程管理（`backend_manager.py`）

```python
class BackendManager:
    def start()      # subprocess 启动 uvicorn
    def stop()       # 优雅关闭（SIGTERM / taskkill）
    def restart()    # stop + start
    def is_running() # 检查 /health 端点
    def get_port()   # 返回运行端口
```

**关键行为**：
- 启动后轮询 `/health` 确认就绪（超时 10s）
- 首次启动成功后自动打开浏览器
- 进程异常退出时自动重启（最多 3 次）
- 退出时发送 SIGTERM，等待 5s 后强制 kill

### 3.4 状态轮询与图标更新

每 5 秒轮询一次 `/sync/tasks/status`：
- 所有任务 idle/success → 绿色图标
- 任何任务 running → 蓝色图标（带旋转动画效果）
- 任何任务 failed 或 last_error 非空 → 红色图标
- 全部暂停 → 灰色图标

### 3.5 系统通知（`notifier.py`）

**触发通知的场景**：
- 同步完成（批量摘要："3 个文件已同步"）
- 检测到冲突（"发现文件冲突，请处理"）
- 严重错误（"同步失败：OAuth Token 过期"）
- 后端异常退出（"后端服务已停止，正在重启..."）

**通知频率控制**：同类通知 60 秒内不重复推送。

### 3.6 开机自启动

**Windows**：
- 在 `%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup` 创建 `.pyw` 快捷方式
- 使用 `winshell` 或 `win32com` 创建 `.lnk`

**macOS**：
- 生成 `~/Library/LaunchAgents/com.larksync.agent.plist`
- `RunAtLoad: true`，指向 Python 解释器 + 启动脚本

### 3.7 一键启动器

```
LarkSync.pyw     # Windows：双击启动，无终端窗口
LarkSync.command  # macOS：双击启动
```

内部逻辑：
```python
import sys, os
sys.path.insert(0, os.path.dirname(__file__))
from apps.tray.tray_app import main
main()
```

## 4. 打包与安装包

### 4.1 PyInstaller 打包

```
scripts/
├── build_installer.py   # 统一构建脚本
├── larksync.spec         # PyInstaller spec 文件
└── installer/
    ├── nsis/             # Windows NSIS 安装脚本
    │   └── larksync.nsi
    └── macos/            # macOS 打包脚本
        └── create_dmg.sh
```

**PyInstaller 配置要点**：
- `--windowed`（无终端窗口）
- `--onedir`（目录模式，避免启动慢）
- `--icon=apps/tray/icons/icon_idle.ico`
- 打包包含：Python runtime + 所有依赖 + 前端 dist/ + 托盘图标
- 数据目录：`data/` 在用户目录下（`%APPDATA%/LarkSync/` 或 `~/Library/Application Support/LarkSync/`）

**构建产物**：
- Windows: `dist/LarkSync/LarkSync.exe` → NSIS 打包为 `LarkSync-Setup-vX.Y.Z.exe`
- macOS: `dist/LarkSync.app` → 打包为 `LarkSync-vX.Y.Z.dmg`

### 4.2 安装包

**Windows (NSIS)**：
- 安装向导界面
- 创建桌面快捷方式（可选）
- 创建开始菜单项
- 注册卸载程序
- 安装路径默认 `C:\Program Files\LarkSync\`

**macOS (DMG)**：
- 拖拽安装（.app → /Applications）
- 签名与公证（可选，需要 Apple Developer Account）

## 5. 后端新增接口

### GET /api/tray/status
返回托盘应用需要的聚合状态：
```json
{
  "backend_running": true,
  "tasks_total": 3,
  "tasks_running": 1,
  "tasks_paused": 0,
  "unresolved_conflicts": 0,
  "last_error": null,
  "last_sync_time": 1707321600.0
}
```

### POST /api/tray/pause-all / POST /api/tray/resume-all
全局暂停/恢复所有同步任务。

## 6. 技术选型

| 组件 | 选择 | 理由 |
|------|------|------|
| 系统托盘 | pystray | 纯 Python，跨平台，轻量 |
| 图标 | Pillow | pystray 依赖，PNG/ICO 生成 |
| 通知 | plyer | 跨平台系统通知，零额外依赖 |
| 前端服务 | FastAPI StaticFiles | 零额外进程，内置 SPA fallback |
| 打包 | PyInstaller | 最成熟的 Python 打包方案 |
| Windows 安装包 | NSIS | 免费、广泛使用、脚本灵活 |
| macOS 安装包 | create-dmg | 标准 .dmg 格式 |
| 自启动 | 原生方式 | Windows .lnk / macOS .plist，最可靠 |

**不选 Electron/Tauri 的理由**：太重（>100MB），引入新语言/框架维护成本高，现有 Web UI 已足够好。

## 7. 新增依赖

```
# apps/backend 或根目录 requirements.txt 追加
pystray>=0.19.5
Pillow>=10.0.0
plyer>=2.1.0

# 打包工具（仅开发/构建时）
pyinstaller>=6.0.0
```

## 8. 用户体验流程

### 安装版用户（v0.5.0+）
1. 下载 `LarkSync-Setup.exe`（Windows）或 `LarkSync.dmg`（macOS）
2. 安装 → 桌面出现 LarkSync 图标
3. 双击启动 → 托盘图标出现 → 浏览器自动打开管理面板
4. 配置 OAuth → 创建同步任务 → 完成
5. 勾选"开机自启动" → 此后全自动

### 开发者用户（v0.4.0）
1. `pip install -r requirements.txt`
2. `python scripts/build.py`（构建前端 + 生成图标）
3. 双击 `LarkSync.pyw` → 托盘启动
4. 或继续用 `npm run dev` 开发模式
