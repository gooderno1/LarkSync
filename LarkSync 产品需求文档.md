# **LarkSync (飞书同步助手) 产品需求文档**

| 文档版本 | 修改日期 | 修改人 | 修改内容 | 备注 |
| :---- | :---- | :---- | :---- | :---- |
| V1.0 | 2026-01-27 | Gemini | 初始版本创建 | 基于可行性调研报告撰写 |

## **1\. 需求背景**

### **1.1 一句话简介**

**为什么**：为了解决重度文档用户（如研发、技术写作）无法利用本地 IDE（VS Code/Obsidian）编辑飞书云文档，以及无法将本地文件无缝备份至飞书协作生态的痛点。 **怎么做**：开发一款运行在本地的“双向同步助手”，通过智能转码引擎连接飞书云端（Docx）与本地文件系统（Markdown/Office）。 **有什么效果**：实现“本地编辑，云端协作”的无缝工作流，打通个人数据孤岛与企业知识库。

### **1.2 需求目标**

* **务虚目标**：提升技术型团队的文档维护效率，降低知识沉淀的门槛；让飞书文档成为连接本地开发环境与团队协作的桥梁。  
* **务实目标**：  
  * 实现 Docx 文档下载到本地时，100% 自动转换为标准 Markdown 格式。  
  * 实现本地 Markdown/Office 文件上传时，自动转换为飞书在线文档（Docx/Sheet）。  
  * 支持 10,000+ 文件规模下的稳定同步，文件遗漏率 0%。  
  * 支持多设备（公司电脑/个人电脑）间的数据一致性。

### **1.3 用户诉求**

| 用户画像 | 典型场景 | 核心痛点 | 期望解决方案 |
| :---- | :---- | :---- | :---- |
| **研发工程师 (Alex)** | 使用 VS Code 编写技术方案，需同步给团队评审。 | 每次都要手动复制粘贴到飞书，格式还需要重新调整；图片得一张张上传。 | 本地 Git 仓库中的 MD 文件能自动变成飞书文档，图片自动上传。 |
| **项目经理 (Sarah)** | 需要备份项目的所有过程资产（文档、表格）。 | 担心云端误删；离线状态下无法查看关键项目表格。 | 自动把云端所有资料同步到本地硬盘，作为归档备份。 |
| **设计师 (Mike)** | 产出大量素材图和 PDF，需要分发给团队。 | 每次都要打开浏览器上传，文件夹层级还得手动建。 | 往本地文件夹一拖，云端自动就有，且层级保持一致。 |

### **1.4 业务诉求**

当前飞书官方提供的 Drive 工具主要针对通用文件流，对于“文档格式互转”缺乏深度支持。本产品通过补齐这一能力，能够增强飞书在极客群体和专业内容创作者中的粘性。

## **2\. 需求概述**

### **2.1 核心流程图**

系统运行核心逻辑包含两条主数据流：**下行同步（云 \-\> 本地）** 与 **上行同步（本地 \-\> 云）**。

graph TD  
    subgraph Cloud \[飞书云端\]  
        CloudDoc\[在线文档 Docx\]  
        CloudFile\[普通文件 XLSX/PDF\]  
    end

    subgraph Local \[本地电脑\]  
        LocalMD\[Markdown 文件\]  
        LocalFile\[普通文件 XLSX/PDF\]  
        Assets\[图片资源文件夹\]  
    end

    SyncCore((LarkSync 核心引擎))

    %% 下行流  
    CloudDoc \--\>|1. 变更感知| SyncCore  
    SyncCore \--\>|2. 格式转码 \+ 下载图片| LocalMD  
    SyncCore \--\>|2b. 引用图片| Assets

    %% 上行流  
    LocalMD \--\>|3. 文件监听| SyncCore  
    SyncCore \--\>|4. 解析 Block \+ 上传图片| CloudDoc  
    LocalFile \--\>|5. 导入转换| CloudFile

### **2.2 关键逻辑说明**

1. **Hub-Satellite 模型**：以飞书云端（Hub）为单一事实来源（SSOT）。本地设备（Satellite）通过 SQLite 状态库记录“上一次同步的时间快照”，以此判断变更方向。  
2. **转码优先**：不同于传统的网盘同步，LarkSync 的核心价值在于“转码”。  
   * Docx ↔ Markdown  
   * Excel → Sheet (单向导入)  
3. **最终一致性**：受限于 API 频率限制（Rate Limiting），系统不追求毫秒级实时，而是通过“轮询 \+ 事件”机制保证分钟级的最终一致性。

## **3\. 需求详述**

### **3.1 模块：初始化与账户授权**

**功能名称**：账户授权与任务配置 **功能位置**：首次启动引导页 / 设置面板 **描述**：用户连接飞书账号，并建立本地文件夹与云端文件夹的映射关系。

#### **3.1.1 授权登录**

* **交互**：点击“登录飞书”按钮 \-\> 唤起浏览器 OAuth 2.0 授权页 \-\> 用户确认 \-\> 跳转回应用。  
* **后端逻辑**：获取 user\_access\_token（非 tenant\_token，确保访问的是用户个人视角的数据）。  
* **特殊说明**：需申请 drive:drive (读写云空间), docs:doc (读写文档), drive:meta (获取时间戳) 权限。

#### **3.1.2 新建同步任务**

* **交互**：弹窗表单。  
  * **本地路径**：调用系统文件选择器。  
  * **云端目标**：展示飞书“我的空间”目录树供选择。  
  * **同步模式**（单选）：  
    * 双向同步：适合协作，两端修改互通。  
    * 仅下载（备份）：适合归档，本地修改不上传，防止误覆盖云端。  
  * **智能转换**（复选，默认开启）：开启后，Office 文件上传自动转为在线文档。

### **3.2 模块：下行同步 (云端 \-\> 本地)**

**功能名称**：云端变更拉取 **触发条件**：定时轮询（默认 5 分钟）或 用户手动点击“立即同步”。

#### **3.2.1 文件夹结构镜像**

* **逻辑**：递归遍历云端文件夹结构。  
* **特殊说明**：  
  * 若云端文件夹重命名，本地对应重命名。  
  * 若云端文件被删除，本地文件移动到系统回收站（而非直接物理删除，防止误判）。

#### **3.2.2 Docx 转 Markdown (核心)**

* **输入**：飞书 Docx 文档（由 Block ID 组成的 JSON 结构）。  
* **处理逻辑**：  
  * **文本样式**：将 text\_run 解析为 MD 语法（粗体 \*\*，斜体 \*，链接 \[\]()）。  
  * **标题**：H1-H9 转换为 \# 语法。  
  * **列表**：处理嵌套层级，转换为 \- 或 1.。  
  * **代码块**：转换为 \`\`\`language ... \`\`\`。  
  * **图片**：  
    1. 识别文档中的 image block。  
    2. 下载图片实体文件到本地同级的 assets/ 目录。  
    3. 在 MD 中插入相对路径引用 \!\[alt\](assets/image\_token.png)。  
* **输出**：.md 文件。  
* **元数据对齐**：文件写入完成后，强制调用 OS API 修改文件的 modified\_time 为云端记录的 latest\_modify\_time。

#### **3.2.3 普通文件下载**

* **逻辑**：PDF、Zip 等不支持转码的文件，直接以二进制流下载。  
* **冲突处理**：如果本地文件已存在且 Hash 不一致，重命名旧文件为 Filename (Conflict Copy).ext，下载新文件。

### **3.3 模块：上行同步 (本地 \-\> 云端)**

**功能名称**：本地变更推送 **触发条件**：文件系统监听器 (Watcher) 捕获到 Create, Modify, Move 事件。

#### **3.3.1 Markdown 转 Docx (核心)**

* **输入**：本地新增或修改的 .md 文件。  
* **处理逻辑**：  
  * **新建场景**：调用 drive/v1/import\_tasks 接口，直接将 .md 导入为云端 Docx。  
  * **更新场景**（技术难点）：  
    * 不建议删除重建（会改变云端 Token，导致原来的分享链接失效）。  
    * **策略**：读取本地 MD \-\> 解析为 AST \-\> 转换为 Feishu Block 结构 \-\> 调用 docx/v1/documents/:id/blocks 接口全量替换文档内容（保留文档 Token 和标题）。  
  * **图片上传**：  
    1. 扫描 MD 内容中的本地图片路径。  
    2. 调用 Media Upload API 上传图片，获取 image\_token。  
    3. 构造 Image Block 插入文档。

#### **3.3.2 Office 格式智能导入**

* **逻辑**：  
  * 若用户开启“智能转换”，当监测到 .xlsx, .docx 文件新增时：  
  * 调用 import\_tasks 接口将其转换为飞书在线 Sheet/Docx。  
  * 转换成功后，将云端的源文件移入“Source Files Backup”文件夹（避免云端同时出现一个 Excel 和一个 Sheet 造成混淆）。

### **3.4 模块：冲突处理与状态机**

**功能名称**：冲突仲裁器 **描述**：当离线期间，云端和本地同时被修改，或者多设备同时修改同一文件时。

#### **3.4.1 仲裁策略**

* **原则**：保全数据，云端优先。  
* **场景 A (内容冲突)**：  
  * 检测到 Local\_Hash \!= DB\_Last\_Hash (本地变了) 且 Cloud\_Version \> DB\_Last\_Version (云端也变了)。  
  * **动作**：  
    1. 将本地文件重命名为 文件名 (冲突副本 时间).md。  
    2. 下载云端最新版本作为主文件。  
    3. 系统托盘弹出通知：“检测到文件冲突，已为您创建副本。”

#### **3.4.2 循环死锁规避**

* **问题**：本地上传 \-\> 触发云端更新 \-\> 云端更新触发本地下载 \-\> 覆盖本地 \-\> 触发本地上传。  
* **解决方案**：  
  * 引入 **"静默期 (Cool-down)"**：程序执行上传操作后，将该 FileID 加入 5 秒白名单，忽略该文件随后的云端变更通知。  
  * **版本锚点**：上传成功后，立即原子更新本地 SQLite 数据库中的 cloud\_version 和 file\_hash。

## **4\. 非功能性需求**

### **4.1 性能要求**

* **QPS 限制**：严格遵守飞书开放平台限制（如 Drive API 写操作 5 QPS）。需实现令牌桶限流算法，遇到 429 错误自动指数退避重试。  
* **内存占用**：在监听 10,000 个文件的目录下，常驻内存需 \< 200MB。

### **4.2 安全性**

* **Token 存储**：access\_token 和 refresh\_token 必须加密存储（Windows 使用 DPAPI，macOS 使用 Keychain），严禁明文存入 config.json。  
* **网络**：所有数据传输强制走 HTTPS。

## **5\. 数据埋点与日志 (可选)**

| 埋点事件 | 参数 | 作用 |
| :---- | :---- | :---- |
| sync\_start | type (auto/manual) | 统计同步触发频率 |
| file\_transcode | from\_fmt, to\_fmt, status, duration | 监控转码功能的耗时与成功率 |
| conflict\_detected | file\_ext | 监控冲突发生的频率，优化同步算法 |
| api\_error | error\_code, endpoint | 监控飞书 API 的稳定性及限流情况 |

## **6\. 附录：文件状态机逻辑简述**

供研发参考的简化逻辑

1. **Idle**: 监听状态。  
2. **LocalChange Detected**:  
   * Check IgnoreList (是否是程序自己改的？) \-\> Yes \-\> Idle。  
   * No \-\> Check SyncMode (是否仅下载？) \-\> Yes \-\> Revert/Notify \-\> Idle。  
   * No \-\> **State: Uploading**。  
3. **Uploading**:  
   * Transcode \-\> Call API \-\> **Success** \-\> Update DB (New Version/Hash) \-\> Add to IgnoreList (5s) \-\> Idle。  
4. **CloudChange Detected**:  
   * Compare Version (Is Cloud\_Version \> DB\_Version?) \-\> No \-\> Idle。  
   * Yes \-\> **State: Downloading**。  
5. **Downloading**:  
   * Check Local Status (Modified since last sync?) \-\> Yes \-\> **Trigger Conflict Flow**。  
   * No \-\> Download & Transcode \-\> Overwrite Local \-\> Update Timestamp \-\> Update DB \-\> Idle。